name: Release MdxViewer

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g. v0.1.0)'
        required: true

permissions:
  contents: write

env:
  DOTNET_VERSION: '10.0.x'
  PROJECT: gillijimproject_refactor/src/MdxViewer/MdxViewer.csproj

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - rid: win-x64
            os_label: Windows x64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Bootstrap library dependencies
        working-directory: gillijimproject_refactor
        run: ./setup-libs.ps1

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore
        run: dotnet restore ${{ env.PROJECT }}

      - name: Publish (${{ matrix.os_label }})
        run: |
          dotnet publish ${{ env.PROJECT }} `
            -c Release `
            -r ${{ matrix.rid }} `
            --self-contained true `
            -p:PublishSingleFile=false `
            -p:IncludeNativeLibrariesForSelfExtract=true `
            -p:TreatWarningsAsErrors=false `
            -o publish/MdxViewer-${{ matrix.rid }}

      - name: Verify definitions bundled
        run: |
          $pubDir = "publish/MdxViewer-${{ matrix.rid }}"
          if (!(Test-Path "$pubDir/definitions/AreaTable.dbd")) {
            Write-Error "WoWDBDefs definitions not found in publish output!"
            exit 1
          }
          $count = (Get-ChildItem "$pubDir/definitions/*.dbd").Count
          Write-Host "Bundled $count .dbd definition files"

      - name: Create ZIP archive
        run: |
          $version = if ("${{ github.event.inputs.version }}") { "${{ github.event.inputs.version }}" } else { "${{ github.ref_name }}" }
          $zipName = "MdxViewer-${version}-${{ matrix.rid }}.zip"
          Compress-Archive -Path "publish/MdxViewer-${{ matrix.rid }}/*" -DestinationPath $zipName
          Write-Host "Created $zipName"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: MdxViewer-${{ matrix.rid }}
          path: MdxViewer-*-${{ matrix.rid }}.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version || github.ref_name }}
          name: MdxViewer ${{ github.event.inputs.version || github.ref_name }}
          body: |
            ## MdxViewer â€” WoW World Viewer

            High-performance .NET 10 / OpenGL 3.3 world viewer for WoW Alpha 0.5.3, 0.6.0, and LK 3.3.5.

            ### Quick Start
            1. Extract the ZIP for your platform
            2. Run `MdxViewer path/to/game/directory`

            ### Requirements
            - OpenGL 3.3+ capable GPU
            - WoW game data (MPQ archives)

            ### What's Included
            - Self-contained .NET 10 runtime (no install needed)
            - WoWDBDefs definitions for DBC parsing
            - Pure C# MPQ reader (no StormLib dependency)
          files: artifacts/MdxViewer-*.zip
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
