name: Release MdxViewer

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g. v0.1.0)'
        required: true

permissions:
  contents: write

env:
  DOTNET_VERSION: '10.0.x'

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            rid: linux-x64
            tfm: net10.0
            project: gillijimproject_refactor/src/MdxViewer/MdxViewer.CrossPlatform.csproj
            os_label: Linux x64
          - os: macos-latest
            rid: osx-x64
            tfm: net10.0
            project: gillijimproject_refactor/src/MdxViewer/MdxViewer.CrossPlatform.csproj
            os_label: macOS x64
          - rid: win-x64
            os: windows-latest
            tfm: net10.0-windows
            project: gillijimproject_refactor/src/MdxViewer/MdxViewer.csproj
            os_label: Windows x64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Bootstrap library dependencies
        working-directory: gillijimproject_refactor
        shell: pwsh
        run: ./setup-libs.ps1

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore
        shell: pwsh
        run: dotnet restore ${{ matrix.project }} -p:TargetFramework=${{ matrix.tfm }} --runtime ${{ matrix.rid }}

      - name: Publish (${{ matrix.os_label }})
        shell: pwsh
        run: |
          dotnet publish ${{ matrix.project }} `
            -c Release `
            -f ${{ matrix.tfm }} `
            -p:TargetFramework=${{ matrix.tfm }} `
            -r ${{ matrix.rid }} `
            --self-contained true `
            -p:PublishSingleFile=false `
            -p:IncludeNativeLibrariesForSelfExtract=true `
            -p:TreatWarningsAsErrors=false `
            -o publish/MdxViewer-${{ matrix.rid }}

      - name: Verify definitions bundled
        shell: pwsh
        run: |
          $pubDir = "publish/MdxViewer-${{ matrix.rid }}"
          if (!(Test-Path "$pubDir/definitions/AreaTable.dbd")) {
            Write-Error "WoWDBDefs definitions not found in publish output!"
            exit 1
          }
          $count = (Get-ChildItem "$pubDir/definitions/*.dbd").Count
          Write-Host "Bundled $count .dbd definition files"

      - name: Bundle README and user guide
        shell: pwsh
        run: |
          $pubDir = "publish/MdxViewer-${{ matrix.rid }}"
          Copy-Item "gillijimproject_refactor/src/MdxViewer/USERGUIDE.md" "$pubDir/USERGUIDE.md"
          Copy-Item "gillijimproject_refactor/src/MdxViewer/README.md" "$pubDir/README.md"

      - name: Create ZIP archive
        shell: pwsh
        run: |
          $version = if ("${{ github.event.inputs.version }}") { "${{ github.event.inputs.version }}" } else { "${{ github.ref_name }}" }
          $zipName = "MdxViewer-${version}-${{ matrix.rid }}.zip"
          Compress-Archive -Path "publish/MdxViewer-${{ matrix.rid }}/*" -DestinationPath $zipName
          Write-Host "Created $zipName"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: MdxViewer-${{ matrix.rid }}
          path: MdxViewer-*-${{ matrix.rid }}.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version || github.ref_name }}
          name: MdxViewer ${{ github.event.inputs.version || github.ref_name }}
          body: |
            ## MdxViewer ${{ github.event.inputs.version || github.ref_name }}

            High-performance .NET 10 / OpenGL 3.3 world viewer for WoW Alpha 0.5.3, 0.6.0, and LK 3.3.5.

            ### What's New
            - **MDX Skeletal Animation** — Full bone hierarchy, keyframe interpolation, GPU skinning
            - **Compressed Quaternion Support** — Ghidra-verified C4QuaternionCompressed decompression for KGRT rotation tracks
            - **Terrain Doodad Animation** — MDX doodads in WorldScene now animate (trees sway, creatures idle, etc.)
            - **WMO Animated Doodads** — Animated MDX doodads embedded in WMOs now update/render correctly
            - **Animation Sequence Selection** — UI panel to browse and switch between animation sequences

            ### Bug Fixes
            - Fixed PIVT chunk order — bone pivots were all (0,0,0) due to PIVT being parsed after BONE
            - Fixed animation update — standalone MDX viewer was not calling animator Update()
            - Fixed KGRT parsing — rotation keys are 8-byte compressed, not 16-byte float4

            ### Quick Start
            1. Extract the ZIP for your platform
            2. Run `MdxViewer path/to/game/directory`

            ### Requirements
            - OpenGL 3.3+ capable GPU
            - WoW game data (MPQ archives)

            ### What's Included
            - Self-contained .NET 10 runtime (no install needed)
            - WoWDBDefs definitions for DBC parsing
            - Pure C# MPQ reader (no StormLib dependency)
          files: artifacts/MdxViewer-*.zip
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
