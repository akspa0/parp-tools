# Mode: PLAN

# Active Context: Verify Geometry & Decode Doodads

**Goal:** Accurately parse PM4/PD4 files, **assemble the core render geometry (`MSVT`/`MSVI`/`MSUR`) into usable OBJ models**, understand the structure and **decode Doodad placements** from `MSLK` and related chunks (like `MDBH`), and provide file dumping tools.

**Current Focus:** **Verifying the assembled render meshes** (`_render_mesh.obj`) generated by the **batch processing test** (`PM4FileTests`). The test now processes all valid PM4 files in a directory.

**Key Background (See archive.md for full history):**
*   `WoWToolbox.FileDumper` tool tested successfully.
*   Manual loading logic for `MDSFChunk` handles empty chunks.
*   `AnalysisTool` PM4/ADT correlation investigation complete.
*   **NEW Insight:** Visualization confirms `MSLK` node entries represent **Doodad placements** (M2/MDX models).
*   **Issue (De-prioritized):** `AnalysisTool` directory processing bug.
*   `MSLK` node entries identified as Doodad placements.
*   Corrected `MSUR`->`MDSF`->`MDOS` linking implemented.
*   Logic added to include unlinked `MSUR` faces as default geometry (state 0).
*   Build and tests successful after render mesh changes.
*   Chunk documentation created in `docs/pm4_pd4_chunks.md`.
*   **`PM4FileTests` refactored for batch processing:** Iterates directory, skips zero-byte files, handles errors per file, and generates outputs for valid PM4s.
*   **Tests passing after batch refactor.**

**Next Steps:**
1.  **Visualize:** User to load **several** of the latest `_render_mesh.obj` files from the `output/development` directory in MeshLab to verify the assembled render geometry. Check face count and appearance across different files.
2.  **(If verification successful) Assemble Doodad data:**
    *   Decode `MSLK` unknown fields (`Unk00`, `Unk01`, `Unk04`, `Unk12`) to extract Doodad properties (Model ID, rotation, scale).
    *   Investigate the link between `MSLK` and `MDBH` for specific model identification.
    *   Determine how `MSPV` geometry relates to `MSLK` placements/paths.
3.  **(Future) WMO Geometry Parsing.**
4.  **(Future) QA:** Re-enable commented assertions and fix any bypassed test code.

**--- (Context Updated: Reflects successful batch processing refactor of PM4FileTests. Next step is visual verification of multiple output meshes.) ---**
