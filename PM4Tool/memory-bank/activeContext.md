# Mode: PLAN

# Active Context: Verify Geometry & Decode Doodads

**Goal:** Accurately parse PM4/PD4 files, **assemble the core render geometry (`MSVT`/`MSVI`/`MSUR`) into a usable OBJ model**, understand the structure and **decode Doodad placements** from `MSLK` and related chunks (like `MDBH`), and provide file dumping tools.

**Current Focus:** **Verifying the assembled render mesh** (`_render_mesh.obj`) generated by the latest test run. The logic now includes correct `MSUR`->`MDSF`->`MDOS` linking and handles unlinked `MSUR` faces (assuming state 0).

**Key Background (See archive.md for full history):**
*   `WoWToolbox.FileDumper` tool tested successfully.
*   Manual loading logic for `MDSFChunk` handles empty chunks.
*   `AnalysisTool` PM4/ADT correlation investigation complete.
*   **NEW Insight:** Visualization confirms `MSLK` node entries represent **Doodad placements** (M2/MDX models). The `Unknown_*` fields likely encode model ID, transform, etc. This significantly raises the priority of future `MSLK` decoding.
*   **Issue (De-prioritized):** `AnalysisTool` directory processing bug.
*   **Previous Step:** Test code exports `MSUR` centroids and `MSCN` points (now less relevant).
*   `MSLK` node entries identified as Doodad placements.
*   Corrected `MSUR`->`MDSF`->`MDOS` linking implemented.
*   Logic added to include unlinked `MSUR` faces as default geometry (state 0).
*   Build and tests successful after these changes.
*   Chunk documentation created in `docs/pm4_pd4_chunks.md`.

**Next Steps:**
1.  **Visualize:** User to load the latest `_render_mesh.obj` in MeshLab to verify the assembled render geometry. Check face count and appearance.
2.  **(If verification successful) Assemble Doodad data:**
    *   Decode `MSLK` unknown fields (`Unk00`, `Unk01`, `Unk04`, `Unk12`) to extract Doodad properties (Model ID, rotation, scale).
    *   Investigate the link between `MSLK` and `MDBH` for specific model identification.
    *   Determine how `MSPV` geometry relates to `MSLK` placements/paths.
3.  **(Future) WMO Geometry Parsing.**
4.  **(Future) QA:** Re-enable commented assertions and fix any bypassed test code.

**--- (Context Updated: Reflects implementation of MSUR->MDSF->MDOS linking, handling of unlinked faces, successful build/test, chunk doc creation. Next step is visual verification.) ---**
