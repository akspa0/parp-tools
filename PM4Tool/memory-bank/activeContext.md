# Mode: PLAN

# Active Context: Verify Geometry & Decode Doodads

**Goal:** Accurately parse PM4/PD4 files, **assemble the core render geometry (`MSVT`/`MSVI`/`MSUR`) into usable OBJ models**, understand the structure and **decode Doodad placements** from `MSLK` and related chunks (like `MDBH`), and provide file dumping tools.

**Current Focus:** **Verifying the assembled render meshes** (`_render_mesh.obj`), **individual transformed meshes** (`_render_mesh_transformed.obj` with `Offset - Coord`), and the **combined transformed mesh** (`combined_render_mesh_transformed.obj`) generated by the batch processing test (`PM4FileTests`).

**Key Background (See archive.md for full history):**
*   `WoWToolbox.FileDumper` tool tested successfully.
*   Manual loading logic for `MDSFChunk` handles empty chunks.
*   `AnalysisTool` PM4/ADT correlation investigation complete.
*   **NEW Insight:** Visualization confirms `MSLK` node entries represent **Doodad placements** (M2/MDX models).
*   **Issue (De-prioritized):** `AnalysisTool` directory processing bug.
*   `MSLK` node entries identified as Doodad placements.
*   Corrected `MSUR`->`MDSF`->`MDOS` linking implemented.
*   Logic added to include unlinked `MSUR` faces as default geometry (state 0).
*   Build and tests successful after render mesh changes.
*   Chunk documentation created in `docs/pm4_pd4_chunks.md`.
*   **`PM4FileTests` refactored for batch processing:** Iterates directory, skips zero-byte files, handles errors per file, and generates outputs for valid PM4s.
*   **`PM4FileTests` Output Changes:**
    *   Removed MSLK hierarchy JSON output.
    *   Added individual transformed render mesh OBJ output (`Offset - Coordinate`).
    *   Added combined transformed render mesh OBJ output (`Offset - Coordinate`, stitched).
*   **Tests passing after latest changes.**

**Next Steps:**
1.  **Visualize & Verify:** User to load the `combined_render_mesh_transformed.obj` and several individual `_render_mesh_transformed.obj` files in MeshLab to verify:
    *   The `Offset - Coordinate` transformation is visually correct.
    *   The face stitching in the combined file is correct (no missing faces compared to individual transformed files).
2.  **(If verification successful) Assemble Doodad data:**
    *   Decode `MSLK` unknown fields (`Unk00`, `Unk01`, `Unk04`, `Unk12`) to extract Doodad properties (Model ID, rotation, scale).
    *   Investigate the link between `MSLK` and `MDBH` for specific model identification.
    *   Determine how `MSPV` geometry relates to `MSLK` placements/paths.
3.  **(Future) WMO Geometry Parsing.**
4.  **(Future) QA:** Re-enable commented assertions and fix any bypassed test code.

**--- (Context Updated: Reflects addition of transformed OBJ outputs (individual & combined), removal of JSON, successful test run. Next step is visual verification of transformed meshes.) ---**
