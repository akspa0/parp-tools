# PM4 Placements ↔ Links Relationship Findings (2025-08-05)

This note documents the current understanding of how `MPRL` **Placements** rows relate to `MSLK`/`Links` rows after running the database-first analytics pipeline.

## Key Tables

| Table | Purpose | Key Fields |
|-------|---------|------------|
| `Placements` (MPRL) | One row per placed object reference in the tile | `Unknown4` (uint) – serves as **ObjectId** |
| `Links` (legacy name for `MSLK`) | One row per hierarchical surface group | `ParentIndex` (uint) – foreign key to `Placements.Unknown4` |

## Relationship Summary

* Each `Placements.Unknown4` value identifies a **sub-component** (not a full building) that appears in the scene.
* Joining `Links` on `ParentIndex = Unknown4` fans out into multiple child rows – these represent the individual geometry groups that form the component.
* Child group multiplicity varies widely:

  ```text
  Object 2   → 60 child groups
  Object 30  →  8 child groups
  Object 479 →  1 child group (degenerate)
  Object 490 → 71 child groups
  ```

* The CSV/summary generated by `analyze-db` now reports `ChildGroupCount` for every ObjectId, confirming the fan-out discovered in earlier manual prototype work.

## Implications

1. **These groupings are still lower-level than complete buildings.**  Further aggregation is required (likely via additional chunk relationships or spatial hierarchy) to reach full objects suitable for export.
2. The current extractor should use the `Placements` ↔ `Links` mapping as **Phase 1** of object assembly, then seek higher-level joins (e.g. `Links` → `Surfaces` groups, container IDs, or the `BoundsCenter*` hierarchy).
3. Future analytics should retain both the raw fan-out table and the aggregated counts to drive heuristics for higher-level grouping.

## Next Steps

### TODO (2025-08-06)

* **Bulk Sub-component Exporter**
  * New CLI: `export-subcomponents <scene.db>` (no extra args).
  * Automatically:
    * Enumerates all distinct `Placements.Unknown4` values.
    * Creates `project_output/<timestamp>/id_<ObjectId>/` per ID.
    * Exports `subcomponent_<id>.obj` with vertices **and faces**.
    * Dumps helper CSVs (`links.csv`, `surfaces.csv`) and `summary.txt`.
    * Generates top-level `index.csv` summarising ObjectId, child-group count, vertex/face totals.
  * No manual selection required – one command yields a full dataset for exploration.

* Document higher-level relationships as they are confirmed (e.g., `Links` ↔ `Surfaces`, container hierarchy).
* Continue iterating toward full object reconstruction using the hierarchical fields uncovered in later discoveries (`BoundsCenterX/Y/Z`, `PackedParams`, etc.).

* Document higher-level relationships as they are confirmed (e.g., `Links` ↔ `Surfaces`, container hierarchy).
* Prototype an extractor that assembles all geometry referenced by a single `Placements.Unknown4` plus its child `Links` rows to visualise what a **sub-component** looks like.
* Continue iterating toward full object reconstruction using the hierarchical fields uncovered in later discoveries (`BoundsCenterX/Y/Z`, `PackedParams`, etc.).
