# PM4 MSCN Analyzer – Investigation & Tooling Plan (2025-08-18)

## Goals
- Clarify how MSCN entries relate to PM4 geometry/object data (MSLK/MSUR) and whether MPRR acts as a range/linkage structure.
- Provide tooling to dump MSCN and MPRR, compute object centroids/AABBs, and associate MSCN↔objects via spatial proximity with optional MPRR gating.
- Compute scene-level placement centroids using MPRL placements matched to MSLK (Unknown4 ↔ ParentIndex), not geometry-only centroids.
- Enable statistical analysis (CSVs) and visual validation (optional GLB overlay).

## Scope
- New console app: `src/PM4MscnAnalyzer/`
- Reuse loaders/assemblers:
  - Region loading: `ParpToolbox.Services.PM4.Pm4GlobalTileLoader.LoadRegion()` → `ToStandardScene()` to ensure `Pm4Scene.MscnVertices` is populated.
  - Object grouping by `MSUR.IndexCount` (full-object grouping), with placements derived from `MPRL.Unknown4` ↔ `MSLK.ParentIndex` mapping.
  - Apply MPRL placement transforms when assembling geometry; replicate geometry per matched placement (multi-instance handling).
- Real data: `./test_data/original_development`.

## Deliverables
- CSVs in `project_output/mscn_analysis/<session>/`:
  - `mscn_points.csv` (tileId, tileX, tileY, x, y, z)
  - `objects.csv` (tileId, tileX, tileY, objectId, center_x, center_y, center_z [placement/MPRL centroid], center_geom_x, center_geom_y, center_geom_z, placement_count, triCount, vertCount, surfaceCount, AABB)
  - `mprr.csv` (raw MPRR fields; tile provenance)
  - `associations.csv` (tileId, objectId, mscnTileId, mscnLocalIndex, x/y/z, distance, rank, thresholds used)
  - Optional: `overlay.glb` with MSCN markers and centroid→MSCN link segments.
  - Links analytics (from `links-dump` + pivots):
    - `placements.csv`, `mprl_mslk_links.csv`
    - `link_category_counts.csv`, `nongeom_type_flag_counts.csv`
    - `nongeom_surface_ref_pairs.csv` (+ optional `nongeom_surface_ref_triples.csv`)
    - `nongeom_surface_ref_stats.csv`, `geom_type_flag_counts.csv`, `placement_profiles_by_tile.csv`
  - Container-aware export:
    - `mslk_by_placement.jsonl` (per-placement containers+geometries)
    - `mslk_container_signatures.csv`, `mslk_geom_signatures.csv`
- Documentation: `docs/Diagnostics_MSCN.md` (methodology, flags, interpretation).

## Commands (PM4MscnAnalyzer)
- `mscn-dump` — `--input <dir>`, `--pattern <glob>`, `--out <path>`, `--session <name>` → `mscn_points.csv`
- `object-centroids` — `--input <dir>`, `--pattern <glob>`, `--out <path>`, `--session <name>` [optional: `--debug-placements`] → `objects.csv`
- `mprr-dump` — `--input <dir>`, `--pattern <glob>`, `--out <path>`, `--session <name>` → `mprr.csv`
- `mscn-associate` — `--session <name>`, `--out <path>`, `--k <int>`, `--max-dist <float>` → `associations.csv` + stats
- `glb-overlay` (optional) — `--session <name>`, `--out <path>`, `--sample <N>` → `overlay.glb`
- `links-dump` — `--input <dir>`, `--pattern <glob>`, `--out <path>`, `--session <name>` → `placements.csv`, `mprl_mslk_links.csv`
- `links-summarize` — `--session <name>`, `--out <path>` → `link_category_counts.csv`, `nongeom_type_flag_counts.csv`
- `links-pivot` — `--session <name>`, `--out <path>` [optional: `--triples`] → pairs/triples/stats/type-flag profiles
- `mslk-export` — `--input <dir>`, `--pattern <glob>`, `--out <path>`, `--session <name>` → JSONL per-placement + signature CSVs

## Data Flow
1) Load region to standard scene (ensuring `MscnVertices`).
2) Assemble objects per tile by `MSUR.IndexCount`; map placements via `MPRL.Unknown4` ↔ `MSLK.ParentIndex`; apply all matched MPRL transforms (replicate geometry per transform); compute both placement centroid (mean of MPRL positions) and geometry centroid; compute AABB.
3) kNN from placement centroids to MSCN with configurable `k` and optional `--max-dist`.

## Architecture Notes
- Per-tile processing remains the core principle; avoid cross-tile contamination.
- Apply all MPRL transforms per surface; do not collapse multiple instances into one.
- Placement centroid = average of matched MPRL positions; Geometry centroid = average of transformed vertices.
- `SpatialIndex` starting with brute-force kNN; upgrade to uniform grid/kd-tree if needed.
- Overlay GLB follows `GltfRawWriter` approach; emit tiny cubes/lines as meshes.

## Validation & Acceptance
- Non-empty CSVs from real region data.
- Nearest-distance distributions show signal; coverage rates reported.
- Placement centroids align with visible MPRL position clusters for selected samples.
- Overlay visually shows MSCN clusters near object placements/bounds.

## Timeline
- Day 1: scaffold project; implement `mscn-dump`, `object-centroids`.
- Day 2: implement `mprr-dump`, `mscn-associate` (kNN + thresholds).
- Day 3: optional `glb-overlay`; write docs; first analysis run.

## Risks & Mitigations
- Unknown MPRR schema → start with raw dump + correlation; iterate naming.
- Performance → start brute-force; add spatial index if required.
- Ambiguity → report 1:N and N:1 matches; multiple thresholds; provide stats.

## References
- `Pm4GlobalTileLoader` MSCN aggregation ensures consistent `MscnVertices` across region loader path.
- Real-data-first validation per project preferences.
