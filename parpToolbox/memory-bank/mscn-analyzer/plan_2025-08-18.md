# PM4 MSCN Analyzer – Investigation & Tooling Plan (2025-08-18)

## Goals
- Clarify how MSCN entries relate to PM4 geometry/object data (MSLK/MSUR) and whether MPRR acts as a range/linkage structure.
- Provide tooling to dump MSCN and MPRR, compute object centroids/AABBs, and associate MSCN↔objects via spatial proximity with optional MPRR gating.
- Enable statistical analysis (CSVs) and visual validation (optional GLB overlay).

## Scope
- New console app: `src/PM4MscnAnalyzer/`
- Reuse loaders/assemblers:
  - Region loading: `ParpToolbox.Services.PM4.Pm4GlobalTileLoader.LoadRegion()` → `ToStandardScene()` to ensure `Pm4Scene.MscnVertices` is populated.
  - Object grouping by `MSLK.ParentIndex_0x04` (verified grouping strategy).
  - Geometry assembly patterns from `RawGeometryAssembler` for vertex set integrity.
- Real data: `./test_data/original_development`.

## Deliverables
- CSVs in `project_output/mscn_analysis/<session>/`:
  - `mscn_points.csv` (tileX, tileY, x, y, z)
  - `objects.csv` (objectId, parentIndex, centroidX, centroidY, centroidZ, triCount, vertCount, AABB)
  - `mprr.csv` (raw MPRR fields; tile provenance)
  - `associations.csv` (objectId, mscnId, dist, withinThreshold, thresholdUsed, mprrGateUsed)
- Optional: `overlay.glb` with MSCN markers and centroid→MSCN link segments.
- Documentation: `docs/Diagnostics_MSCN.md` (methodology, flags, interpretation).

## Commands (PM4MscnAnalyzer)
- `mscn-dump` — `--in`, `--out`, `--per-region` → `mscn_points.csv`
- `object-centroids` — `--in`, `--out`, `--per-region`, `--grouping parent-index` → `objects.csv`
- `mprr-dump` — `--in`, `--out`, `--per-region` → `mprr.csv`
- `mscn-associate` — `--in`, `--out`, `--per-region`, `--nn 1|3`, `--thresholds 3,5,10`, `--use-mprr` → `associations.csv` + stats
- `glb-overlay` (optional) — `--in`, `--out`, `--per-region`, `--sample <N>` → `overlay.glb`

## Data Flow
1) Load region to standard scene (ensuring `MscnVertices`).
2) Group objects by `MSLK.ParentIndex_0x04`; build vertex sets; compute centroid + AABB.
3) kNN from centroids to MSCN with configurable thresholds.
4) Optional MPRR gating if fields indicate ranges/windows; compare precision.

## Architecture Notes
- `ObjectCentroidCalculator` to compute centroids/AABBs from per-object vertices.
- `SpatialIndex` starting with brute-force kNN; upgrade to uniform grid/kd-tree if needed.
- Overlay GLB follows `GltfRawWriter` approach; emit tiny cubes/lines as meshes.

## Validation & Acceptance
- Non-empty CSVs from real region data.
- Nearest-distance distributions show signal; coverage rates reported.
- `--use-mprr` improves precision/uniqueness if MPRR gates MSCN.
- Overlay visually shows MSCN clusters near object placements/bounds.

## Timeline
- Day 1: scaffold project; implement `mscn-dump`, `object-centroids`.
- Day 2: implement `mprr-dump`, `mscn-associate` (kNN + thresholds).
- Day 3: optional `glb-overlay`; write docs; first analysis run.

## Risks & Mitigations
- Unknown MPRR schema → start with raw dump + correlation; iterate naming.
- Performance → start brute-force; add spatial index if required.
- Ambiguity → report 1:N and N:1 matches; multiple thresholds; provide stats.

## References
- `Pm4GlobalTileLoader` MSCN aggregation ensures consistent `MscnVertices` across region loader path.
- Real-data-first validation per project preferences.
