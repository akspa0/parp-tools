# Terrain Overlay System - FULLY INTEGRATED âœ…

## Summary

The complete terrain overlay system is now fully integrated into the WoWRollback pipeline!

**Final Integration**: ViewerReportWriter now generates terrain overlays automatically during viewer generation.

---

## What Was Fixed

### Issue
The overlay JSON files weren't being generated - we had built the extraction and transformation code but never called it.

### Solution
Integrated `McnkTerrainOverlayBuilder` into the viewer generation pipeline:

**File Modified**: `ViewerReportWriter.cs`

1. âœ… Added `GenerateTerrainOverlays()` method (47 lines)
2. âœ… Called once per map per version during overlay generation
3. âœ… Updated `CopyViewerAssets()` to copy `js/overlays/` directory
4. âœ… Added deduplication to prevent redundant generation

---

## How It Works

### Automatic Generation Flow

```
WoWRollback compare-versions
  â””â”€> ViewerReportWriter.Generate()
      â””â”€> For each map and version:
          â”œâ”€> Generate object overlays (combined, m2, wmo)
          â””â”€> GenerateTerrainOverlays()
              â”œâ”€> Look for CSV: {root}/{version}/csv/{map}/{map}_mcnk_terrain.csv
              â”œâ”€> Load AreaTable (if available)
              â””â”€> Call McnkTerrainOverlayBuilder.BuildOverlaysForMap()
                  â””â”€> Output: overlays/{version}/{map}/terrain_complete/tile_r{row}_c{col}.json
```

---

## Output Structure

```
rollback_outputs/comparisons/{comparison_key}/viewer/
â”œâ”€â”€ index.html (with terrain overlay controls)
â”œâ”€â”€ styles.css (with overlay styling)
â”œâ”€â”€ js/
â”‚   â”œâ”€â”€ main.js (with overlay manager integration)
â”‚   â””â”€â”€ overlays/
â”‚       â”œâ”€â”€ terrainPropertiesLayer.js
â”‚       â”œâ”€â”€ liquidsLayer.js
â”‚       â”œâ”€â”€ holesLayer.js
â”‚       â”œâ”€â”€ areaIdLayer.js
â”‚       â””â”€â”€ overlayManager.js
â”œâ”€â”€ minimap/{version}/{map}/
â”‚   â””â”€â”€ {map}_{col}_{row}.png
â””â”€â”€ overlays/{version}/{map}/
    â”œâ”€â”€ combined/
    â”‚   â””â”€â”€ tile_r{row}_c{col}.json (object placements)
    â”œâ”€â”€ m2/
    â”‚   â””â”€â”€ tile_r{row}_c{col}.json (M2 models only)
    â”œâ”€â”€ wmo/
    â”‚   â””â”€â”€ tile_r{row}_c{col}.json (WMO objects only)
    â””â”€â”€ terrain_complete/
        â””â”€â”€ tile_r{row}_c{col}.json â­ NEW! (MCNK terrain data)
```

---

## CSV Requirements

For terrain overlays to be generated, the following CSV must exist:

**Path**: `{rootDirectory}/{version}/csv/{map}/{map}_mcnk_terrain.csv`

**Generated By**: AlphaWDTAnalysisTool with `--extract-mcnk-terrain` flag

**Example**:
```
test_data/0.5.3.3368/csv/Azeroth/Azeroth_mcnk_terrain.csv
```

### Optional: AreaTable CSVs

For area names in overlays:
- `{rootDirectory}/{version}/AreaTable_Alpha.csv`
- `{rootDirectory}/{version}/AreaTable_335.csv`

If these don't exist, terrain overlays work fine but area boundaries won't have names.

---

## Complete Usage

### Step 1: Extract Terrain Data

```bash
AlphaWdtAnalyzer --input "path/to/Azeroth.wdt" \
  --listfile "community_listfile.csv" \
  --out "test_data/0.5.3.3368" \
  --extract-mcnk-terrain \
  --extract-mcnk-shadows
```

**Output**: CSV files in `test_data/0.5.3.3368/csv/Azeroth/`

### Step 2: Generate Viewer with Terrain Overlays

```bash
cd WoWRollback
.\rebuild-and-regenerate.ps1 `
  -Maps @("Azeroth","Kalimdor") `
  -Versions @("0.5.3.3368") `
  -AlphaRoot ..\test_data\ `
  -Serve
```

**What Happens**:
1. Builds WoWRollback solution
2. Runs `compare-versions` command
3. ViewerReportWriter detects terrain CSVs
4. Generates terrain overlay JSON files
5. Copies all viewer assets (including new overlay JS)
6. Starts web server

### Step 3: View in Browser

Open http://localhost:8000 and:
1. Open sidebar (hamburger menu)
2. Scroll to **"Terrain Overlays"** section
3. Check overlays you want to see:
   - â˜‘ï¸ Terrain Properties
   - â˜‘ï¸ Liquids
   - â˜‘ï¸ Holes
   - â˜‘ï¸ Area Boundaries
4. Pan/zoom map to load tiles

---

## Optimization

**Deduplication**: Terrain overlay generation uses a `HashSet` to track already-generated maps, preventing redundant work.

```csharp
var terrainKey = $"{version}_{mapName}";
if (!terrainOverlaysGenerated.Contains(terrainKey))
{
    GenerateTerrainOverlays(...);
    terrainOverlaysGenerated.Add(terrainKey);
}
```

**Result**: Each map is processed exactly once per version, regardless of how many tiles it has.

---

## Error Handling

### Graceful Degradation

If terrain CSV doesn't exist:
- âœ… System logs: "No CSV data, skip terrain overlays"
- âœ… Viewer still works (just no terrain overlays)
- âœ… Object overlays unaffected

If AreaTable doesn't exist:
- âœ… Terrain overlays still generated
- âœ… Area boundaries shown but without names
- âœ… System continues normally

If terrain generation fails:
- âœ… Warning logged but build continues
- âœ… Other overlays still generated
- âœ… Viewer still functional

---

## Testing Checklist

### Verify Integration

- [x] Build succeeds without errors
- [x] Terrain CSV detected during viewer generation
- [x] Terrain overlay JSON files created in `terrain_complete/` folder
- [x] ViewerAssets files (HTML/CSS/JS) copied to output
- [x] `js/overlays/` directory copied to output
- [x] Viewer loads without JavaScript errors
- [x] Terrain overlay controls visible in sidebar
- [x] Checking overlay toggles loads and displays overlays
- [x] Pan/zoom triggers new overlay loads
- [x] Opacity sliders update overlay transparency
- [x] Sub-options work (show/hide impassible, liquids, etc.)

---

## Performance Notes

### JSON File Sizes

**Per Tile** (typical):
- Object overlays: ~5-20 KB
- Terrain complete: ~10-50 KB
- Total per tile: ~15-70 KB

**Per Continent** (4096 tiles):
- Total terrain overlays: ~40-200 MB uncompressed
- With HTTP compression: ~10-50 MB transferred

### Load Performance

- Debounced loading (500ms) prevents thrashing
- Tile caching (keeps nearby tiles in memory)
- Lazy loading (only visible tiles)
- Typical viewport: 6-16 tiles loaded

---

## Complete File Manifest

### Created Files (Phase 2-5)
1. `AlphaWdtAnalyzer.Core/Terrain/McnkTerrainEntry.cs`
2. `AlphaWdtAnalyzer.Core/Terrain/McnkTerrainExtractor.cs`
3. `AlphaWdtAnalyzer.Core/Terrain/McnkTerrainCsvWriter.cs`
4. `AlphaWdtAnalyzer.Core/Terrain/McnkShadowEntry.cs`
5. `AlphaWdtAnalyzer.Core/Terrain/McnkShadowExtractor.cs`
6. `AlphaWdtAnalyzer.Core/Terrain/McnkShadowCsvWriter.cs`
7. `WoWRollback.Core/Models/McnkModels.cs`
8. `WoWRollback.Core/Services/McnkTerrainCsvReader.cs`
9. `WoWRollback.Core/Services/AreaTableReader.cs`
10. `WoWRollback.Core/Services/Viewer/TerrainPropertiesOverlayBuilder.cs`
11. `WoWRollback.Core/Services/Viewer/LiquidsOverlayBuilder.cs`
12. `WoWRollback.Core/Services/Viewer/HolesOverlayBuilder.cs`
13. `WoWRollback.Core/Services/Viewer/AreaIdOverlayBuilder.cs`
14. `WoWRollback.Core/Services/Viewer/McnkTerrainOverlayBuilder.cs`
15. `ViewerAssets/js/overlays/terrainPropertiesLayer.js`
16. `ViewerAssets/js/overlays/liquidsLayer.js`
17. `ViewerAssets/js/overlays/holesLayer.js`
18. `ViewerAssets/js/overlays/areaIdLayer.js`
19. `ViewerAssets/js/overlays/overlayManager.js`

### Modified Files
20. `AlphaWdtAnalyzer.Core/AnalysisPipeline.cs` (added terrain extraction options)
21. `AlphaWdtAnalyzer.Core/BatchAnalysis.cs` (added terrain extraction options)
22. `AlphaWdtAnalyzer.Cli/Program.cs` (added CLI flags)
23. `WoWRollback.Core/Services/Viewer/ViewerReportWriter.cs` (integrated terrain generation)
24. `ViewerAssets/index.html` (added overlay controls)
25. `ViewerAssets/styles.css` (added overlay styling)
26. `ViewerAssets/js/main.js` (integrated overlay manager)

**Total**: 26 files (19 new, 7 modified)
**Total LOC**: ~2,600 lines

---

## âœ… COMPLETE: Full Stack Integration

The terrain overlay system is now **completely integrated** from extraction to visualization:

1. âœ… **Extraction** - AlphaWDTAnalysisTool extracts MCNK data to CSV
2. âœ… **Transformation** - WoWRollback.Core transforms CSV to JSON
3. âœ… **Visualization** - ViewerAssets displays overlays interactively
4. âœ… **Integration** - ViewerReportWriter ties it all together
5. âœ… **Automation** - rebuild-and-regenerate.ps1 does it all

**Ready for**: Production use! ğŸ‰
