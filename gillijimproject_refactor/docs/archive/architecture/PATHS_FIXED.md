# Terrain Overlay Paths - CORRECTED âœ…

## Summary

Fixed the path logic to ensure we **only write to output folders**, never to test_data.

---

## Correct Path Structure

### Input Data (Read-Only)
```
test_data/0.5.3/          â† Read-only! Never write here!
â””â”€â”€ World/
    â””â”€â”€ Maps/
        â”œâ”€â”€ Azeroth/
        â”‚   â””â”€â”€ Azeroth.wdt
        â””â”€â”€ Kalimdor/
            â””â”€â”€ Kalimdor.wdt
```

### CSV Output (Generated by AlphaWDTAnalysisTool)
```
rollback_outputs/{version}/{map}/
â”œâ”€â”€ {map}_mcnk_terrain.csv â­ Terrain data
â”œâ”€â”€ {map}_mcnk_shadow.csv
â”œâ”€â”€ id_ranges_by_map_alpha_{map}.csv
â””â”€â”€ AreaTable_Alpha.csv (optional)
```

**Example**:
```
rollback_outputs/0.5.3/Azeroth/
â”œâ”€â”€ Azeroth_mcnk_terrain.csv
â”œâ”€â”€ Azeroth_mcnk_shadow.csv
â””â”€â”€ id_ranges_by_map_alpha_Azeroth.csv
```

### JSON Output (Generated by WoWRollback)
```
rollback_outputs/comparisons/{comparison_key}/viewer/
â””â”€â”€ overlays/{version}/{map}/
    â”œâ”€â”€ combined/
    â”‚   â””â”€â”€ tile_r{row}_c{col}.json (object placements)
    â”œâ”€â”€ m2/
    â”‚   â””â”€â”€ tile_r{row}_c{col}.json (M2 models)
    â”œâ”€â”€ wmo/
    â”‚   â””â”€â”€ tile_r{row}_c{col}.json (WMO objects)
    â””â”€â”€ terrain_complete/ â­ Terrain overlays
        â””â”€â”€ tile_r{row}_c{col}.json
```

**Example**:
```
rollback_outputs/comparisons/0_5_3_vs_0_5_5/viewer/
â””â”€â”€ overlays/0.5.3/Azeroth/
    â””â”€â”€ terrain_complete/
        â”œâ”€â”€ tile_r31_c34.json
        â”œâ”€â”€ tile_r31_c35.json
        â””â”€â”€ ...
```

---

## Code Flow

### 1. Extract Terrain CSVs

```bash
AlphaWdtAnalyzer --input "test_data/0.5.3/World/Maps/Azeroth/Azeroth.wdt" \
  --out "rollback_outputs/0.5.3" \
  --extract-mcnk-terrain
```

**Reads**: `test_data/0.5.3/` (read-only)  
**Writes**: `rollback_outputs/0.5.3/Azeroth/Azeroth_mcnk_terrain.csv`

### 2. Generate Viewer Overlays

```bash
WoWRollback compare-versions --versions 0.5.3 --maps Azeroth \
  --root rollback_outputs \
  --viewer-report
```

**Reads**: 
- `rollback_outputs/0.5.3/Azeroth/Azeroth_mcnk_terrain.csv`
- `rollback_outputs/0.5.3/Azeroth/id_ranges_by_map_alpha_Azeroth.csv`

**Writes**: 
- `rollback_outputs/comparisons/{key}/viewer/overlays/0.5.3/Azeroth/terrain_complete/*.json`

---

## Fixed Code

### ViewerReportWriter.cs

```csharp
private static void GenerateTerrainOverlays(
    string rootDirectory,  // = "rollback_outputs"
    string version,        // = "0.5.3"
    string mapName,        // = "Azeroth"
    string overlayVersionRoot, // = "rollback_outputs/comparisons/{key}/viewer/overlays/0.5.3/"
    string safeMapName)
{
    // Look for CSV in: rollback_outputs/{version}/{map}/{map}_mcnk_terrain.csv
    var mapDir = Path.Combine(rootDirectory, version, mapName);
    var terrainCsvPath = Path.Combine(mapDir, $"{mapName}_mcnk_terrain.csv");
    
    if (!File.Exists(terrainCsvPath))
        return; // CSV not found, skip
    
    // Pass mapDir (rollback_outputs/0.5.3/Azeroth/) to builder
    McnkTerrainOverlayBuilder.BuildOverlaysForMap(
        mapName,
        mapDir,                // CSV source directory
        overlayVersionRoot,    // JSON output directory
        version,
        areaLookup
    );
}
```

### McnkTerrainOverlayBuilder.cs

```csharp
public static void BuildOverlaysForMap(
    string mapName,    // = "Azeroth"
    string csvDir,     // = "rollback_outputs/0.5.3/Azeroth/"
    string outputDir,  // = "rollback_outputs/comparisons/{key}/viewer/overlays/0.5.3/"
    string version,    // = "0.5.3"
    AreaTableLookup? areaLookup = null)
{
    // Read CSV from: rollback_outputs/0.5.3/Azeroth/Azeroth_mcnk_terrain.csv
    var terrainCsvPath = Path.Combine(csvDir, $"{mapName}_mcnk_terrain.csv");
    
    // ...process data...
    
    // Write JSON to: rollback_outputs/comparisons/{key}/viewer/overlays/0.5.3/Azeroth/terrain_complete/
    var overlayDir = Path.Combine(outputDir, mapName, "terrain_complete");
    var outPath = Path.Combine(overlayDir, $"tile_r{tileRow}_c{tileCol}.json");
    File.WriteAllText(outPath, json);
}
```

---

## Path Validation

### âœ… Correct Behavior

1. **Read from test_data**: âœ… Read-only access
2. **Write CSVs to rollback_outputs**: âœ… Version-specific folders
3. **Write JSONs to rollback_outputs/comparisons**: âœ… Comparison-specific folders

### âŒ Previously Incorrect (FIXED)

1. ~~Writing to test_data~~: âŒ NEVER do this!
2. ~~Looking for CSVs in test_data/csv/~~: âŒ CSVs are in rollback_outputs
3. ~~Double version path (overlays/{version}/{version}/)~~: âŒ Fixed path concatenation

---

## Testing the Fix

### 1. Extract Terrain Data

```bash
cd AlphaWDTAnalysisTool
AlphaWdtAnalyzer --input "..\test_data\0.5.3\World\Maps\Azeroth\Azeroth.wdt" \
  --out "..\rollback_outputs\0.5.3" \
  --extract-mcnk-terrain
```

**Check Output**:
```
rollback_outputs/0.5.3/Azeroth/Azeroth_mcnk_terrain.csv  â† Should exist
```

### 2. Generate Viewer

```bash
cd WoWRollback
.\rebuild-and-regenerate.ps1 `
  -Maps @("Azeroth") `
  -Versions @("0.5.3") `
  -AlphaRoot ..\test_data\ `
  -Serve
```

**Check Output**:
```
rollback_outputs/comparisons/0_5_3/viewer/
â””â”€â”€ overlays/0.5.3/Azeroth/
    â””â”€â”€ terrain_complete/
        â”œâ”€â”€ tile_r31_c34.json  â† Should exist
        â”œâ”€â”€ tile_r31_c35.json
        â””â”€â”€ ...
```

**Console Output Should Show**:
```
[info] Generated terrain overlays for Azeroth (0.5.3)
Built 42 terrain overlay tiles for Azeroth (0.5.3)
```

### 3. Verify No Writes to test_data

```bash
# After running, check test_data is unchanged
git status test_data/  # Should show "nothing to commit"
```

---

## âœ… COMPLETE: Paths Fixed!

All file operations now correctly:
1. âœ… Read from test_data (read-only)
2. âœ… Write CSVs to rollback_outputs/{version}/{map}/
3. âœ… Write JSONs to rollback_outputs/comparisons/{key}/viewer/
4. âœ… Never write to test_data

The terrain overlay system is now fully operational with correct paths! ğŸ‰
