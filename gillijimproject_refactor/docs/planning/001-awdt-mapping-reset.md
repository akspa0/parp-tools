# AWDT Mapping Reset and Diagnostics Plan

Status: Draft
Owner: AWDT/DBCTool mapping

## 1) Objectives and Non‑Negotiables
- Stabilize mapping for all maps (Azeroth, Kalimdor, etc.) with fully deterministic, CSV‑only logic.
- Treat every Alpha AreaNumber as zone-only (`alphaZoneId = alphaPacked >> 16`); ignore subzone bits in 0.5.x data.
- Prefer via‑060 rows as the authoritative bridge; never cross‑continent.
- Keep the writer (AlphaWDTAnalysisTool) strictly numeric and map‑locked; no heuristics or LK dumps.
- Observability first: expose what happened, where, and why in verify outputs.
- DBCTool produces explicit CSVs; suggestions are reviewed and promoted to explicit before the writer consumes them.

## 1a) Simplified Mapping Contract
- Input: Alpha packed AreaNumber, decoded to `alphaZoneId` using only the high 16 bits.
- Lookup chain: `alphaZoneId` → 0.5.x `AreaTable.dbc` row → canonical zone name (plus alias variants).
- Map-lock via Map.dbc crosswalk to keep results on the same continent/map family.
- Match LK 3.3.5 zone rows (where `ParentAreaID == ID`) by exact/alias/fuzzy name inside the locked continent.
- Output: single LK `AreaID` per `(srcMapId, alphaZoneId)` written to `compare/v2/Area_patch_crosswalk_map{mapId}.csv`.
- Special cases: `alpha_raw == 0` records emitted as `alpha_zero` suggestions with `target_areaId = -1`.

## 2) Inputs and Baselines
- Archived “known‑good” crosswalks (baseline):
  - `DBCTool.V2/dbctool_outputs/session_20250918_152406/compare/v2`
- Current crosswalks:
  - `dbctool_out/<alias>/compare/v2`
- Primary code surfaces (for later phases):
  - `AlphaWDTAnalysisTool/AlphaWdtAnalyzer.Core/Export/AdtWotlkWriter.cs`
    - `PatchMcnkAreaIdsOnDiskV2(...)`
    - `WriteAreaVerifyCsv(...)`
  - `AlphaWDTAnalysisTool/AlphaWdtAnalyzer.Core/Export/DbcPatchMapping.cs`
  - `AlphaWDTAnalysisTool/AlphaWdtAnalyzer.Cli/Program.cs`

## 3) Phase 1 — Observability and Diagnostics
- Add per‑tile verify counters in `WriteAreaVerifyCsv(...)` for:
  - `patch_csv_num_mapX_via060`
  - `patch_csv_num_mapX`
  - `patch_csv_num_mapNameX_via060`
  - `patch_csv_num_mapNameX`
  - `patch_csv_num`
  - `unmapped`
- Emit a one‑line summary per tile; optional per‑map rollup CSV at:
  - `csv/maps/<MapName>/areaid_verify_summary.csv`
- Add a `CrosswalkAuditor` utility:
  - Inputs: “loaded crosswalk set” vs archived baseline set.
  - For each `(src_mapId, src_areaNumber)`: report via060 coverage presence, target deltas, conflicts.
  - Output: `csv/audits/crosswalk_diff_<MapId_or_Name>.csv`
- Goal: quantify whether failures are due to CSV coverage gaps, map‑name mismatches, or selection logic.

## 4) Phase 2 — Selection Invariants (Document then Enforce)
- Selection order and guards (documented here and in code comments):
  1. MapId‑locked zone row `(srcMapId, alphaZoneId)` — prefer via060 entries; else non‑via.
  2. Target mapName‑locked zone row using resolved LK map name (0 → Eastern Kingdoms, 1 → Kalimdor, 530 → Outland, 571 → Northrend).
  3. Src_mapName‑scoped zone row (prefer via060 when both exist).
  4. Else `0` (`unmapped`).
- Guards:
  - Strict same‑map only. No cross‑map acceptance.
  - LK target must have `ParentAreaID == ID` (top-level zone). Reject child rows.
- CLI toggle `--require-via060`:
  - When on, only accept via060 rows for (1) and (2); otherwise fall through to (3) or `unmapped`.
  - Default off.

## 5) Phase 3 — Decode Guard (Report‑Only)
- If `alpha_areaid_decode.csv` exists (generated by DBCTool):
  - In verify only (no write decisions change), report violations where the selected target’s LK map does not match decode‑implied continent.
  - Highlight any zone whose decoded continent differs from the LK target’s MapID.
  - Output: `csv/maps/<MapName>/areaid_verify_violations.csv`.
  - Surface conflicting overrides (zone name matched via manual alias but continent mismatch) as warnings.

## 6) Phase 4 — DBCTool Pipeline (Bridge + Suggestions)
- Execute the stepwise plan (Parts A–E) with zone-only focus:
  - A: Remap export explicit‑only (`method == "explicit"`).
  - B: (superseded) Remove subzone matching helpers; zone is the only lookup key.
  - C: `alpha_areaid_decode.csv` (record zone-only decode: `alphaZoneId`, source map, continent).
  - D: `alpha_to_335_suggestions.csv`:
    - Zone-only name matching with map/continent bias.
    - Apply `NameVariants` (article flips + aliases) and fuzzy matching for renamed zones.
    - Annotate rows resolved through 0.6.0 bridge or manual override.
    - Handle `alpha_raw == 0` with method `alpha_zero` (no LK IDs, `-1`).
  - E: Write the two new CSVs and log counts.
- Outcome: accumulate explicit, map‑locked zone CSVs that the writer can safely consume.

## 6a) Validation and Override Workflow
- **Continent lock checks**
  - `CrosswalkAuditor` asserts every `(srcMapId, alphaZoneId)` resolves to an LK zone with matching continent.
  - Flag any LK target whose `MapID` differs from the map crosswalk; require manual override justification.
- **Duplicate & collision detection**
  - Detect when multiple Alpha zones select the same LK `AreaID`. Log collisions and gate acceptance behind explicit override lists.
  - Maintain `overrides/alpha_zone_to_lk.csv` documenting rationale (`rename`, `merged`, `unavailable`).
- **Fuzzy and alias transparency**
  - Annotate `alpha_to_335_suggestions.csv` with `match_method` (`exact`, `alias`, `fuzzy`, `bridge_060`, `override_manual`).
  - Require manual promotion of `fuzzy`/`override_manual` rows before they appear in explicit crosswalks.
- **Verify outputs**
  - `areaid_verify_<x>_<y>.csv` records: original packed value, decoded `alphaZoneId`, LK `AreaID` written, and `source_csv`.
  - `areaid_verify_summary.csv` aggregates: total tiles, via060 hits, alias/fuzzy usage, overrides consumed, unmapped count.
- **Regression guardrails**
  - Golden sessions compare `areaid_verify_summary.csv` against baseline tolerances (continent mismatches = 0, overrides stable).
  - CI fails if new unmapped zones appear or if fuzzy usage increases without corresponding override entries.

## 7) Phase 5 — Suggestions Mode (Outside Writer)
- Add an AWDT “suggestions mode”:
  - Read `alpha_to_335_suggestions.csv` and generate `suggested_patch.csv` for human review.
  - No writes to ADTs from suggestions; only explicit rows make it into crosswalk CSVs on next build.
- Optional: local tiny LLM only for name normalization
  - Offline (Ollama/llama.cpp). Limited to generating/validating `NameVariants`.
  - Still zone‑locked and map‑locked; no cross‑map choices.
  - Any accepted suggestions are promoted to explicit in the next CSV build.

## 8) Phase 6 — Golden Tests and CI
- Golden verify CSVs for representative tiles in Azeroth and Kalimdor (and one map for 530/571).
- CI smoke tests fail if:
  - Any cross‑map selection occurs.
  - via060 usage drops below a threshold for known‑good tiles.
  - `unmapped` increases beyond a defined tolerance vs baseline.

## 9) Acceptance Criteria
- For a defined set of known tiles:
  - No cross‑map results.
  - Subzones resolve to correct child targets (i.e., `lk_areaid != tgt_parentid` when a child exists).
  - Majority of matches come from via060 where the archived session had via060 coverage.
  - Verify summaries and rollups match the archived baseline within tight tolerances.
- CrosswalkAuditor shows no net regressions vs the archived session for those tiles.

## 10) Delivery Artifacts
- `docs/planning/001-awdt-mapping-reset.md` (this plan).
- `csv/maps/<MapName>/areaid_verify_<x>_<y>.csv` (existing) + per‑tile summary lines.
- `csv/maps/<MapName>/areaid_verify_summary.csv`.
- `csv/audits/crosswalk_diff_<Map>.csv`.
- Optional: `csv/maps/<MapName>/areaid_verify_violations.csv` (report‑only).
- Optional: `out/suggested_patch.csv` (from suggestions mode).

## 11) Implementation Map (by file)
- `AdtWotlkWriter.cs`
  - `WriteAreaVerifyCsv(...)`: add counters + rollup; optional violations output.
  - `PatchMcnkAreaIdsOnDiskV2(...)`: confirm strict order, guards, and `--require-via060` effect.
- `DbcPatchMapping.cs`
  - Ensure via060‑preferred dictionaries and child‑over‑parent tie‑breaks for both mapId and mapName targets.
- `Program.cs` (CLI)
  - Add `--require-via060`; print via usage summary per map when `--verbose`.
- `DBCTool.V2` (Parts A–E)
  - `CompareAreas` + `Program.cs` for explicit‑only exports and new CSVs.

## 12) Rollback Plan
- Keep a working branch and re‑run with archived session CSVs.
- If any phase introduces regressions, disable via flags:
  - `--require-via060` (on/off)
  - Suggestions mode is opt‑in
  - Decode guard is report‑only

## 13) Next Steps
- Implement Phase 1 (counters, rollups, auditor) behind flags.
- Run with archived session CSVs as baseline; inspect summaries.
- Proceed to Phase 2 enforcement only after Phase 1 confirms selection order is transparent and issues are localized.
