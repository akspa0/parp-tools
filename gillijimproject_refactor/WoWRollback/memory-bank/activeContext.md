# WoWRollback Active Context

## Current Focus: VLM Terrain Data Export (Dec 2025)

### Session Summary (2025-12-26)

**Goal**: Export VLM dataset with terrain + placements for AI training.

**Status**: PARTIAL SUCCESS - Placements work, terrain still null

**What Works**:
- VLM Export exports minimap PNGs ✓
- Placements from MPQ (M2/WMO with UniqueID, position, rotation, scale) ✓
- JSON metadata files created with full placement data ✓
- CSV fallback for cached placements ✓

**What's Still Broken**:
- Terrain data is always `null` in JSON
- MpqAdtExtractor finds MPQ but terrain extraction returns null

**New Code Added (PM4Module)**:
- `MpqAdtExtractor.ExtractPlacements()` - MDDF/MODF parsing ✓
- `MpqAdtExtractor.ExtractTerrain()` - MTEX/MCNK/MCVT parsing (not returning data)
- `AlphaWdtExtractor.cs` - Alpha 0.5.3 WDT format support (NEW)
- `AdtDataService.cs` - Unified extraction API (NEW)
- Data models: `M2Placement`, `WmoPlacement`, `TileTerrainData`, `ChunkTerrainData`

**VLM Output Now Includes**:
```json
{
  "tile_id": "Azeroth_32_48",
  "placements": [
    { "type": "M2", "uniqueId": 12345, "posX": ..., "rotX": ..., "scale": ... },
    { "type": "WMO", "uniqueId": 67890, "doodadSet": 0, ... }
  ],
  "terrain": null  // <-- Still broken
}
```

**Next Steps to Fix Terrain**:
1. Debug why `ExtractTerrain()` returns null - may be MCNK subchunk parsing
2. Compare with working CLI `AdtMpqTerrainExtractor` implementation
3. Consider: have GUI read terrain from cache generated by CLI "Prepare Layers"

---

## Key Extraction Code Paths

| Component | File | Status |
|-----------|------|--------|
| MPQ Reading | `PM4Module/MpqAdtExtractor.cs` | ✓ Working |
| Placements | `MpqAdtExtractor.ExtractPlacements()` | ✓ Working |
| Terrain | `MpqAdtExtractor.ExtractTerrain()` | ✗ Returns null |
| Alpha WDT | `PM4Module/AlphaWdtExtractor.cs` | NEW (untested) |
| Unified API | `PM4Module/AdtDataService.cs` | NEW (untested) |

---

## Previous Focus: PM4 → ADT Pipeline (Dec 2025)

## CK24 Structure
```
CK24 = [Type:8bit][ObjectID:16bit]
- 0x00XXXX = Nav mesh (SKIP)
- 0x40XXXX = Has pathfinding data
- 0x42XXXX / 0x43XXXX = WMO-type objects
```

## Do NOT
- Match CK24=0x000000 to WMOs (it's nav mesh)
- Read PM4 tiles independently for cross-tile objects
