# Object Placement Coordinates in Alpha WoW

## Problem

Alpha 0.5.3 WDT files **do not store world coordinates** in MDDF/MODF chunks. All placement coordinates are (0,0,0).

This is not a bug in our tooling - Blizzard hadn't implemented placement coordinates yet in this early Alpha build.

## Solution

We extract coordinates from **converted Lich King ADT files** that were generated by `AlphaWDTAnalysisTool`.

When Alpha WDT is converted to LK format, the conversion process generates proper world coordinates.

## Usage

### Step 1: Convert Alpha WDT to LK ADT

Run `AlphaWDTAnalysisTool` to convert Alpha WDT files to Lich King ADT format:

```bash
# This generates converted ADT files in output_dirfart2/
AlphaWDTAnalysisTool convert <alpha_wdt_path> -o output_dirfart2/
```

### Step 2: Generate Alpha Analysis with Coordinates
First, analyze each Alpha WDT with coordinates from converted ADTs:

```bash
# For each version and map, run:
dotnet run --project WoWRollback.Cli -- analyze-alpha-wdt \
    --wdt-file "test_data/0.5.3/tree/World/Maps/Kalimdor/Kalimdor.wdt" \
    --converted-adt-dir "output_dirfart2/World/Maps/Kalimdor" \
    --out rollback_outputs

# For 0.5.5:
dotnet run --project WoWRollback.Cli -- analyze-alpha-wdt \
    --wdt-file "test_data/0.5.5/tree/World/Maps/Kalimdor/Kalimdor.wdt" \
    --converted-adt-dir "output_dirfart2/World/Maps/Kalimdor" \
    --out rollback_outputs
```

This generates CSV files with proper coordinates in `rollback_outputs/0.5.3/Kalimdor/` and `rollback_outputs/0.5.5/Kalimdor/`

### Step 3: Compare Versions

Now run the comparison (which reads from the generated CSVs):

```bash
dotnet run --project WoWRollback.Cli -- compare-versions \
    --versions 0.5.3,0.5.5 \
    --maps Kalimdor \
    --viewer-report
```

### Step 4: View Results

The viewer will now show:
- ✅ **Accurate world coordinates** (X, Y, Z) for each object
- ✅ **Correct minimap positions** with blue dots at actual object locations
- ✅ **Proper diff detection** for moved objects

## Technical Details

### How It Works

1. **Alpha WDT Analysis**: Extracts object lists and UniqueIDs from Alpha WDT (coordinates are 0,0,0)
2. **LK ADT Coordinate Lookup**: Reads MDDF/MODF from converted LK ADT files (coordinates are populated)
3. **UniqueID Matching**: Maps UniqueIDs from Alpha to coordinates from LK
4. **Viewer Generation**: Outputs JSON with real world coordinates and pixel positions

### File Structure

Converted LK ADT files must follow this structure:
```
output_dirfart2/
  World/
    Maps/
      Kalimdor/
        Kalimdor_30_30.adt  ← Contains MDDF/MODF with coordinates
        Kalimdor_30_31.adt
        ...
      Azeroth/
        Azeroth_30_30.adt
        ...
```

### Coordinate Formats

**In converted LK ADT files** (on-disk):
- FourCC chunks are **byte-reversed**: `FDDM` (MDDF), `FDOM` (MODF)
- Coordinates at offsets 8, 12, 16 (X, Z, Y)
- Entry sizes: 36 bytes (MDDF), 64 bytes (MODF)

**In viewer JSON**:
```json
{
  "uniqueId": 230658,
  "fileName": "stonetree02.mdx",
  "world": {
    "x": 15990.69,
    "y": 16191.14,
    "z": 42.67
  },
  "pixel": {
    "x": 234,
    "y": 156
  }
}
```

## Troubleshooting

### Objects still show (0,0,0)

**Cause**: Converted ADT directory not specified or not found

**Fix**: 
1. Verify converted ADT files exist: `ls output_dirfart2/World/Maps/Kalimdor/*.adt`
2. Check path is absolute
3. Look for log message: `[info] Building coordinate lookup from converted LK ADT files...`

### Some objects have coordinates, others don't

**Cause**: Not all tiles have been converted

**Fix**: Ensure all Alpha WDT tiles were converted to LK ADT format

### Viewer shows objects at tile origins

**Cause**: Running without `--converted-adt-dir` parameter

**Fix**: Add the parameter with full path to converted ADT directory

## Performance

Coordinate lookup adds minimal overhead:
- ~1-2 seconds per map to build UniqueID → coordinate lookup table
- Caches coordinates in memory during comparison
- No impact on viewer rendering speed
